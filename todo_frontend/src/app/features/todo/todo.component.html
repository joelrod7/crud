<div class="wrap mat-typography">
  <div class="bar">
    <h2>Gesti贸n de Tareas y Usuarios</h2>
    <button mat-stroked-button color="warn" (click)="logout()">Salir</button>
  </div>

  <div *ngIf="errorMsg()" class="alert error">{{ errorMsg() }}</div>

  <!-- Filtros y Paginaci贸n -->
  <!-- <div class="card filters" [formGroup]="filterForm">
    <div class="row-4">
      <label>Buscar
        <input type="text" formControlName="search" placeholder="t铆tulo o descripci贸n...">
      </label>
      <label>Estado
        <select formControlName="estado">
          <option [ngValue]="null">Todos</option>
          <option *ngFor="let s of statusOpts" [ngValue]="s.value">{{ s.label }}</option>
        </select>
      </label>
      <label>Usuario
        <select formControlName="asignado">
          <option [ngValue]="null">Todos</option>
          <option *ngFor="let u of users(); trackBy: trackByUser" [ngValue]="u.id">
            {{ fullName(u) }}
          </option>
        </select>
      </label>
      <label>P谩gina
        <select [value]="pageSize()" (change)="setPageSize($any($event.target).value)">
          <option [value]="5">5</option>
          <option [value]="10">10</option>
          <option [value]="20">20</option>
        </select>
      </label>
    </div>

    <div class="paginator">
      <button class="btn" (click)="goToPage(page()-1)">&laquo;</button>
      <button class="btn" *ngFor="let p of pages()" [class.active]="p===page()" (click)="goToPage(p)">{{ p }}</button>
      <button class="btn" (click)="goToPage(page()+1)">&raquo;</button>
      <span class="muted">Total: {{ total() }}</span>
    </div>
  </div> -->

  <div class="grid-2">
    <mat-card class="mat-elevation-z2">
      <h3>Registrar usuario</h3>
      <form [formGroup]="userForm" (ngSubmit)="saveUser()" class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>CC</mat-label>
          <input matInput type="number" formControlName="ident">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Correo</mat-label>
          <input matInput type="email" formControlName="correo">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Nombre</mat-label>
          <input matInput formControlName="nombre">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Apellido</mat-label>
          <input matInput formControlName="apellido">
        </mat-form-field>

        <mat-form-field appearance="outline" class="full">
          <mat-label>Password</mat-label>
          <input matInput type="password" formControlName="password">
        </mat-form-field>

        <button mat-raised-button color="primary" type="submit" [disabled]="creatingUser() || userForm.invalid">
          {{ creatingUser() ? 'Guardando...' : 'Guardar usuario' }}
        </button>
      </form>
    </mat-card>

    <mat-card class="mat-elevation-z2">
      <h3>Crear tarea</h3>
      <form [formGroup]="taskForm" (ngSubmit)="saveTask()" class="form-grid">
        <mat-form-field appearance="outline">
          <mat-label>T铆tulo</mat-label>
          <input matInput formControlName="titulo" maxlength="20">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Estado</mat-label>
          <mat-select formControlName="estado">
            <mat-option *ngFor="let s of statusOpts" [value]="s.value">{{ s.label }}</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="outline" class="full">
          <mat-label>Descripci贸n</mat-label>
          <input matInput formControlName="descripcion" maxlength="100">
        </mat-form-field>

        <mat-form-field appearance="outline">
          <mat-label>Inicio</mat-label>
          <input matInput [ngxMatDatetimePicker]="fiPicker" formControlName="fecha_inicio" placeholder="Elegir fecha y hora">
          <ngx-mat-datepicker-toggle matSuffix [for]="fiPicker"></ngx-mat-datepicker-toggle>
          <ngx-mat-datetime-picker #fiPicker [showSpinners]="true" [stepMinute]="5"></ngx-mat-datetime-picker>
        </mat-form-field>

        <!-- Fin -->
        <mat-form-field appearance="outline">
          <mat-label>Fin</mat-label>
          <input matInput [ngxMatDatetimePicker]="ffPicker" formControlName="fecha_fin" placeholder="Elegir fecha y hora">
          <ngx-mat-datepicker-toggle matSuffix [for]="ffPicker"></ngx-mat-datepicker-toggle>
          <ngx-mat-datetime-picker #ffPicker [showSpinners]="true" [stepMinute]="5"></ngx-mat-datetime-picker>
        </mat-form-field>

        <button mat-raised-button color="primary" type="submit" [disabled]="creatingTask() || taskForm.invalid">
          {{ creatingTask() ? 'Guardando...' : 'Guardar tarea' }}
        </button>
      </form>
    </mat-card>
  </div>

  <!-- Listados -->
  <div class="grid-2">
    <mat-card class="mat-elevation-z1">
      <h3>Usuarios</h3>
      <div class="table-wrap" [class.loading]="loadingUsers()">
        <table class="mat-elevation-z1">
          <thead>
            <tr><th>CC</th><th>Nombre</th><th>Correo</th></tr>
          </thead>
          <tbody>
            <tr *ngFor="let u of users(); trackBy: trackByUser">
              <td>{{ u.ident }}</td>
              <td>{{ fullName(u) }}</td>
              <td>{{ u.correo }}</td>
            </tr>
            <tr *ngIf="!loadingUsers() && users().length === 0">
              <td colspan="3" class="empty">Sin usuarios</td>
            </tr>
          </tbody>
        </table>
        <div class="spinner" *ngIf="loadingUsers()">
          <mat-spinner diameter="36"></mat-spinner>
        </div>
      </div>
    </mat-card>

    <mat-card class="mat-elevation-z1">
      <h3>Tareas</h3>
      <div class="table-wrap" [class.loading]="loadingTasks()">
        <table class="mat-elevation-z1">
          <thead>
            <tr>
              <th>T铆tulo</th>
              <th>Descripci贸n</th>
              <th>Creaci贸n</th>
              <th>Inicio</th>
              <th>Fin</th>
              <th>Estado</th>
              <th>Asignado</th>
              <th class="center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let t of tasks(); trackBy: trackByTask">
              <ng-container *ngIf="editingId() !== t.id; else editRow">
                <td>{{ t.titulo }}</td>
                <td>{{ t.descripcion }}</td>
                <td>{{ t.fecha_creacion | date:'short' }}</td>
                <td>{{ t.fecha_inicio | date:'short' }}</td>
                <td>{{ t.fecha_fin | date:'short' }}</td>
                <td>{{ statusLabel(t.estado) }}</td>
                <td>{{ assignedName(t.asignado) }}</td>
                <td class="center">
                  <button mat-stroked-button color="primary" (click)="startEdit(t)">Editar</button>
                  <button mat-stroked-button color="warn"
                          [disabled]="savingRow()===t.id"
                          (click)="hideTask(t)">
                    Ocultar
                  </button>
                </td>
              </ng-container>

              <ng-template #editRow>
                <td colspan="7">
                  <form [formGroup]="editForm" class="row-edit">
                    <div class="row-3">
                      <mat-form-field appearance="outline">
                        <mat-label>T铆tulo</mat-label>
                        <input matInput formControlName="titulo" maxlength="20">
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Estado</mat-label>
                        <mat-select formControlName="estado">
                          <mat-option *ngFor="let s of statusOpts" [value]="s.value">{{ s.label }}</mat-option>
                        </mat-select>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Asignado</mat-label>
                        <mat-select formControlName="asignado">
                          <mat-option [value]="null">--</mat-option>
                          <mat-option *ngFor="let u of users(); trackBy: trackByUser" [value]="u.id">{{ fullName(u) }}</mat-option>
                        </mat-select>
                      </mat-form-field>
                    </div>

                    <mat-form-field appearance="outline" class="full">
                      <mat-label>Descripci贸n</mat-label>
                      <input matInput formControlName="descripcion" maxlength="100">
                    </mat-form-field>

                    <div class="row-2">
                      <mat-form-field appearance="outline">
                        <mat-label>Inicio</mat-label>
                        <input matInput [ngxMatDatetimePicker]="fiPicker2" formControlName="fecha_inicio">
                        <!--  usar el toggle de ngx, NO el de Mat -->
                        <ngx-mat-datepicker-toggle matSuffix [for]="fiPicker2"></ngx-mat-datepicker-toggle>
                        <ngx-mat-datetime-picker #fiPicker2 [showSpinners]="true" [stepMinute]="5"></ngx-mat-datetime-picker>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Fin</mat-label>
                        <input matInput [ngxMatDatetimePicker]="ffPicker2" formControlName="fecha_fin">
                        <ngx-mat-datepicker-toggle matSuffix [for]="ffPicker2"></ngx-mat-datepicker-toggle>
                        <ngx-mat-datetime-picker #ffPicker2 [showSpinners]="true" [stepMinute]="5"></ngx-mat-datetime-picker>
                      </mat-form-field>
                    </div>
                  </form>
                </td>
                <td class="center">
                  <button mat-raised-button color="primary" [disabled]="savingRow()===t.id || editForm.invalid" (click)="saveEdit(t)">
                    {{ savingRow()===t.id ? 'Guardando...' : 'Guardar' }}
                  </button>
                  <button mat-stroked-button (click)="cancelEdit()">Cancelar</button>
                </td>
              </ng-template>
            </tr>

            <tr *ngIf="!loadingTasks() && tasks().length === 0">
              <td colspan="8" class="empty">Sin tareas</td>
            </tr>
          </tbody>
        </table>

        <div class="spinner" *ngIf="loadingTasks()">
          <mat-spinner diameter="36"></mat-spinner>
        </div>
      </div>

      <div class="paginator bottom">
        <button mat-button (click)="goToPage(page()-1)">&laquo;</button>
        <button mat-stroked-button *ngFor="let p of pages()" [color]="p===page() ? 'primary' : undefined" (click)="goToPage(p)">{{ p }}</button>
        <button mat-button (click)="goToPage(page()+1)">&raquo;</button>
        <span class="muted">Total: {{ total() }}</span>
      </div>
    </mat-card>
  </div>
</div>
